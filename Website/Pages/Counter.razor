@page "/counter"
@using Microsoft.EntityFrameworkCore
@using Microsoft.EntityFrameworkCore.Internal
@using System.Text.RegularExpressions
@using Website.Data
@inject DiscordService Discord
@inject IDbContextFactory<WebsiteContext> WebContextFactory
@inject IvaoApiService Api

<PageTitle>Counter</PageTitle>

<h1>Counter</h1>

<Authenticated>
    <p role="status">Current count: @currentCount</p>

    <button class="btn btn-primary" @onclick="() => _ = IncrementCountAsync(context)">Click me</button>
</Authenticated>

@code {
    private int currentCount = 0;

    private async Task IncrementCountAsync(IvaoLoginData loginData)
    {
        ++currentCount;

        var db = WebContextFactory.CreateDbContext();
        var user = await db.Users.FindAsync(loginData.Vid);

        if (user is null)
            return;

        await Discord.EnforceRolesAsync(loginData, user, Api);
        await db.SaveChangesAsync();
    }
}
